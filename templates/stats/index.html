<!DOCTYPE html>
{% extends 'base.html' %}
{% load static %}
{% block content %}
{% include 'navbar.html' %}

<!-- Contenedor principal -->
<div class="container mt-5">
    <h2 class="text-center">Estadísticas</h2>

    <!-- Formulario para filtrar por fecha y categoría -->
    <form method="GET" action="{% url 'stats' %}" class="row mb-4">
        <div class="col-md-4">
            <label for="start_date">Fecha Inicio:</label>
            <input type="date" name="start_date" class="form-control" id="start_date" />
        </div>
        <div class="col-md-4">
            <label for="end_date">Fecha Fin:</label>
            <input type="date" name="end_date" class="form-control" id="end_date" />
        </div>
        <div class="col-md-4">
            <label for="category_id">Categorías:</label>
            <select name="category" class="form-control" id="category">
                <option value="">Selecciona</option>
                {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-12 mt-3 text-center">
            <button type="submit" class="btn" style="background-color: #5f0293; color: white;">
                Aplicar Filtros
            </button>
            <button type="button" class="btn" style="background-color: red; color: white; margin-left: 10px;"
                onclick="location.href='http://127.0.0.1:8000/stats/?start_date=&end_date=&category='">
                Eliminar Filtros
            </button>
        </div>
    </form>

    <!-- Condición para verificar si existen datos -->
    {% if not no_data %}

    <!-- Gráficas principales -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm rounded">
                <div class="card-body">
                    <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">
                        Categorías más creadas
                    </h3>
                    <canvas id="byCategory" class="w-100" style="height: 200px"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm rounded">
                <div class="card-body">
                    <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">
                        Repeticiones por Hábito
                    </h3>
                    <canvas id="habitRadarChart" class="w-100" style="height: 200px"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm rounded">
                <div class="card-body">
                    <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">
                        Frecuencias más usadas
                    </h3>
                    <canvas id="completionChart" class="w-100" style="height: 200px"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Nuevas Gráficas -->
    <div class="row">
        <!-- Tarjeta de Hábitos Creados -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm rounded">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="card-title mb-0">Hábitos Creados</h3>
                        <span class="badge" style="background-color: #5f0293">{{ total_habits_created }}</span>
                    </div>
                    <div class="d-flex justify-content-center">
                        <canvas id="stepsChart" class="w-100" style="height: 280px"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta del Hábito Específico -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm rounded">
                <div class="card-body">
                    <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">
                        Hábito Específico
                    </h3>
                    <form method="GET" class="mt-3 text-center">
                        <select name="habit_id" id="habit_id" class="form-select">
                            {% for habit in user_habits %}
                            <option value="{{ habit.id }}" {% if habit.id|stringformat:"s" == request.GET.habit_id %}selected{% endif %}>
                                {{ habit.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn"
                            style="background-color: #5f0293; color: white; margin-top: 10px;">Filtrar</button>
                    </form>
                    <div style="margin: 20px 0;">
                        <canvas id="waterChart" class="w-100" style="height: 300px"></canvas>
                    </div>
                    <div class="text-start mt-3">
                        <p>Progreso Actual <span class="float-end">{{ best_progress }}</span></p>
                        <hr />
                        <p>Progreso Total <span class="float-end">{{ expected_progress }}</span></p>
                        <hr />
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta de Progreso Diario de Hábitos -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm rounded">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h3 class="text-left" style="color: #000000">Progreso Acumulado</h3>
                    </div>
                    <canvas id="allHabitsProgressChart" class="w-100" style="height: 280px"></canvas>
                </div>
            </div>
        </div>

    </div>

    {% else %}
    <!-- Mensaje cuando no hay datos -->
    <div class="alert alert-info text-center mt-4">
        <p>No se encontraron datos para la fecha o categoría seleccionada.</p>
    </div>
    {% endif %}

</div>

<!-- Librería de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

    const categories = JSON.parse('{{ byCategory | safe }}');
    //   const categories = {{ byCategory | safe }};
    const categoriesName = Object.keys(categories);
    const categoriesValue = Object.values(categories);



    // Datos dinámicos para las frecuencias
    const frequencies = JSON.parse('{{ byFrequency | safe }}');
    //   const frequencies = {{ byFrequency | safe }};
    const frequenciesName = Object.keys(frequencies);
    const frequenciesValue = Object.values(frequencies);

    const totalSum = categoriesValue.reduce((a, b) => a + b);


    const bgcolors = categoriesName.map(category => {
        switch (category) {
            case 'Escuela':
                return 'rgba(0, 102, 204, 0.6)';
            case 'Trabajo':
                return 'rgba(255, 20, 147, 0.6)';
            case 'Hogar':
                return 'rgba(255, 140, 0, 0.6)';
            case 'Salud':
                return 'rgba(9, 192, 122, 0.6)';
            case 'Hobby':
                return 'rgba(133, 0, 207, 0.6)';
            case 'Otros':
                return 'rgba(128, 128, 0, 0.6)';
            default:
                return 'rgba(204, 204, 204, 0.6)';
        }
    });

    // Gráfico de frecuencias
    var ctxByCategory = document.getElementById('byCategory').getContext('2d');

    var byCategoryChart = new Chart(ctxByCategory, {
        type: 'doughnut',
        data: {
            labels: categoriesName,
            datasets: [{
                data: categoriesValue,
                backgroundColor: bgcolors,
                borderColor: '#DAF7A6',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#A9A9A9',
                        font: {
                            family: 'Anta',
                            size: 14
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (args) {
                            const percentage = (args.raw / totalSum * 100).toFixed(2);
                            return `${percentage}% del total`;
                        }
                    }
                }
            }
        }
    });


    const habit_names = JSON.parse('{{ habit_names | safe }}');
    const habit_repetitions = JSON.parse('{{ habit_repetitions | safe }}');

    var ctx = document.getElementById('habitRadarChart').getContext('2d');
    var habitRadarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: habit_names,
            datasets: [{
                label: 'Repeticiones',
                data: habit_repetitions,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)',
            }]
        },
        options: {
            responsive: true,
            elements: {
                line: {
                    tension: 0.3
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#A9A9A9',
                        font: {
                            family: 'Anta',
                            size: 14
                        }
                    }
                },
            },
            scales: {
                r: {
                    angleLines: {
                        display: true
                    },
                    pointLabels: {
                        color: '#A9A9A9',
                        font: {
                            family: 'Anta',
                            size: 14
                        }
                    },
                    ticks: {
                        beginAtZero: true,
                        display: false,
                        color: '#000000',
                        font: {
                            family: 'Anta',
                            size: 14
                        }
                    },
                    suggestedMin: 0,
                    suggestedMax: Math.max(...habit_repetitions) + 2
                }
            }
        }
    });

    const frequency_labels = JSON.parse('{{ frequency_labels | safe }}');
    const frequency_data = JSON.parse('{{ frequency_data | safe }}');

    var ctx = document.getElementById('completionChart').getContext('2d');
    var completionChart = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: frequency_labels,
            datasets: [{
                label: 'Frecuencia de hábitos',
                data: frequency_data,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#A9A9A9',
                        font: {
                            family: 'Anta',
                            size: 14
                        }
                    }
                },
            },
            scales: {
                r: {
                    ticks: {
                        beginAtZero: true,
                        display: false,
                        color: '#000000',
                        font: {
                            family: 'Anta',
                            size: 14
                        }
                    },
                    pointLabels: {
                        color: '#A9A9A9',
                        font: {
                            family: 'Anta',
                            size: 14
                        }
                    }
                }
            }
        }
    });



    // Nuevas Gráficas
    document.addEventListener('DOMContentLoaded', function () {

        // Gráfico de hábitos creados
        var ctxSteps = document.getElementById('stepsChart').getContext('2d');

        var gradientSteps = ctxSteps.createLinearGradient(0, 0, 0, 400);
        gradientSteps.addColorStop(0, 'rgba(255, 99, 132, 1)');
        gradientSteps.addColorStop(0.1, 'rgba(255, 99, 132, 0.9)');
        gradientSteps.addColorStop(0.2, 'rgba(255, 99, 132, 0.7)');
        gradientSteps.addColorStop(0.3, 'rgba(255, 99, 132, 0.5)');
        gradientSteps.addColorStop(0.5, 'rgba(255, 99, 132, 0.3)');
        gradientSteps.addColorStop(0.7, 'rgba(255, 99, 132, 0.2)');
        gradientSteps.addColorStop(0.9, 'rgba(255, 99, 132, 0.1)');
        gradientSteps.addColorStop(1, 'rgba(255, 99, 132, 0)');

        const labels_stepsChart = JSON.parse('{{ labels | safe }}');
        const data_stepsChart = JSON.parse('{{ data | safe }}');

        // const labels_stepsChart = {{labels|safe}};
        // const data_stepsChart = {{data|safe}};

        var stepsChart = new Chart(ctxSteps, {
            type: 'line',
            data: {
                labels: labels_stepsChart,
                datasets: [{
                    label: 'Hábitos creados',
                    data: data_stepsChart,
                    borderColor: '#FF464F',
                    borderWidth: 2,
                    fill: true,
                    backgroundColor: gradientSteps,
                    pointRadius: 0,
                    pointHoverRadius: 8,
                    pointHoverBorderColor: '#FF464F',
                    pointHoverBackgroundColor: 'white'
                }]
            },
            options: {
                elements: {
                    point: {
                        radius: function (context) {
                            return context.dataIndex === 2 ? 10 : 0;
                        },
                        backgroundColor: function (context) {
                            return context.dataIndex === 2 ? '#FF464F' : 'rgba(255, 99, 132, 0)';
                        },
                        borderColor: function (context) {
                            return context.dataIndex === 2 ? '#FFFFFF' : '#FF464F';
                        },
                        borderWidth: 5,
                    },
                    line: {
                        tension: 0.4
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) {
                                return 'Hábitos: ' + tooltipItem.raw;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            borderDash: [5, 5],
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: '#A9A9A9',
                            font: {
                                family: 'Anta',
                                size: 14
                            },
                            maxRotation: 75,
                            minRotation: 75
                        }
                    },
                    y: {
                        display: false
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 10
                    }
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        const habit_labels = JSON.parse('{{ habit_labels | safe }}');
        const habit_labels_length = JSON.parse('{{ habit_labels|length }}');
        const total_repetitions = JSON.parse('{{ total_repetitions | safe }}');
        const habit_data = JSON.parse('{{ habit_data | safe }}');

        // Gráfico del Hábito Específico
        var ctxWater = document.getElementById('waterChart').getContext('2d');
        var waterChart = new Chart(ctxWater, {
            type: 'bar',
            data: {
                labels: habit_labels,
                datasets: [
                    {
                        label: 'Progreso Total',
                        data: Array(habit_labels_length).fill(total_repetitions),
                        backgroundColor: '#FF464F' + '80',
                        borderWidth: 1,
                        borderRadius: 10,
                        borderSkipped: false,
                        barThickness: 15
                    },
                    {
                        label: 'Progreso Actual',
                        data: habit_data,
                        backgroundColor: '#FF464F',
                        borderWidth: 1,
                        borderRadius: 10,
                        borderSkipped: false,
                        barThickness: 15
                    }
                ]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#A9A9A9',
                            font: {
                                size: 14,
                                family: 'Anta'
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: total_repetitions,
                        ticks: {
                            display: false
                        },
                        grid: {
                            color: '#E0E0E0',
                            borderDash: [5, 5],
                            drawBorder: false
                        }
                    }
                }
            }
        });


        // Define los colores para cada día de la semana
        var dayColors = {
            0: '#FF464F',
            1: '#36A2EB',
            2: '#FFCE56',
            3: '#4BC0C0',
            4: '#9966FF',
            5: '#FF9F40',
            6: '#FF6384'
        };

        const all_habits_labels = JSON.parse('{{ all_habits_labels | safe }}');
        const all_habits_total_data = JSON.parse('{{ all_habits_total_data | safe }}');
        const all_habits_current_data = JSON.parse('{{ all_habits_current_data | safe }}');

        // Generar un array de colores basados en el día de la semana para el progreso actual
        var barColorsCurrent = all_habits_labels.map(function (label) {
            var date = new Date(label);
            return dayColors[date.getDay()];
        });

        var barColorsTotal = barColorsCurrent.map(function (color) {
            return color + '80';
        });

        var ctxAllHabits = document.getElementById('allHabitsProgressChart').getContext('2d');
        var allHabitsProgressChart = new Chart(ctxAllHabits, {
            type: 'bar',
            data: {
                labels: all_habits_labels,
                datasets: [
                    {
                        label: 'Progreso Total',
                        data: all_habits_total_data,
                        backgroundColor: barColorsTotal,
                        borderWidth: 1,
                        borderRadius: 10,
                        borderSkipped: false,
                        barThickness: 15
                    },
                    {
                        label: 'Progreso Actual',
                        data: all_habits_current_data,
                        backgroundColor: barColorsCurrent,
                        borderWidth: 1,
                        borderRadius: 10,
                        borderSkipped: false,
                        barThickness: 15
                    }
                ]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#A9A9A9',
                            font: {
                                family: 'Anta',
                                size: 14
                            },
                            maxRotation: 75,
                            minRotation: 75
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            display: false
                        },
                        grid: {
                            color: '#E0E0E0',
                            borderDash: [5, 5],
                            drawBorder: false
                        }
                    }
                }
            }
        });


    });
</script>

{% endblock %}