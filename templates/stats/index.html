<!DOCTYPE html>
{% extends 'base.html' %} 
{% load static %} 
{% block content %} 
{% include 'navbar.html' %}

<!-- Contenedor principal -->
<div class="container mt-5">
  <h2 class="text-center">Estadísticas</h2>

  <!-- Formulario para filtrar por fecha y categoría -->
  <form method="GET" action="{% url 'stats' %}" class="row mb-4">
    <div class="col-md-4">
      <label for="start_date">Fecha Inicio:</label>
      <input
        type="date"
        name="start_date"
        class="form-control"
        id="start_date"
      />
    </div>
    <div class="col-md-4">
      <label for="end_date">Fecha Fin:</label>
      <input type="date" name="end_date" class="form-control" id="end_date" />
    </div>
    <div class="col-md-4">
      <label for="categoria">Categorías:</label>
      <select name="categoria" class="form-control" id="categoria">
        <!-- Mostrar dinámicamente las categorías -->
        <option value="">Selecciona</option>
        {% for c in categories %}
        <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-12 mt-3 text-center">
      <button
        type="submit"
        class="btn"
        style="background-color: #5f0293; color: white"
      >
        Aplicar Filtros
      </button>
    </div>
  </form>

  <!-- Gráficas principales -->
  <div class="row">
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm rounded">
        <div class="card-body">
          <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">
            Frecuencias más usadas
          </h3>
          <canvas id="habitRadarChart" class="w-100" style="height: 200px"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm rounded">
        <div class="card-body">
          <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">
            Categorías más creadas
          </h3>
          <canvas id="byCategory" class="w-100" style="height: 200px"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm rounded">
        <div class="card-body">
          <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">
            Frecuencias más usadas
          </h3>
          <canvas id="completionChart" class="w-100" style="height: 200px"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Nuevas Gráficas -->
  <div class="row">
    <!-- Tarjeta de Hábitos Creados -->
<div class="col-md-4 mb-4">
  <div class="card shadow-sm rounded">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="card-title mb-0">Hábitos Creados</h3>
        <span class="badge" style="background-color: #5f0293">{{ total_habits_created }}</span>
      </div>
      <div class="d-flex justify-content-center"> <!-- Contenedor para centrar la gráfica -->
        <canvas id="stepsChart" class="w-100" style="height: 280px"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Tarjeta del Hábito Específico -->
<div class="col-md-4 mb-4">
  <div class="card shadow-sm rounded">
      <div class="card-body">
          <h3 class="card-title mb-0 text-start" style="font-family: 'Anta'">  <!-- Añadido text-start -->
              Hábito Específico
          </h3>
          <form method="GET" class="mt-3 text-center">  <!-- Añadido text-center para centrar el formulario -->
              <select name="habit_id" id="habit_id" class="form-select">
                  {% for habit in user_habits %}
                  <option value="{{ habit.id }}" {% if habit.id|stringformat:"s" == request.GET.habit_id %}selected{% endif %}>
                      {{ habit.name }}
                  </option>
                  {% endfor %}
              </select>
              <button type="submit" class="btn" style="background-color: #5f0293; color: white; margin-top: 10px;">Filtrar</button>
          </form> 
          <div style="margin: 20px 0;">
              <canvas id="waterChart" class="w-100" style="height: 300px"></canvas>
          </div>
          <div class="text-start mt-3">
              <p>Hoy <span class="float-end">{{ today_progress }}</span></p>
              <hr />
              <p>Mejor <span class="float-end">{{ best_progress }}</span></p>
              <hr />
              <p>Promedio <span class="float-end">{{ average_progress }}</span></p>
              <hr />
              <p>Progreso Final Esperado <span class="float-end">{{ expected_progress }}</span></p>
              <hr />
          </div>
      </div>
  </div>
</div>

    <!-- Tarjeta de Progreso Diario de Hábitos -->
<div class="col-md-4 mb-4">
  <div class="card shadow-sm rounded">
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <h3 class="text-left" style="color: #ffffff">Progreso Acumulado</h3>
      </div>
      <canvas
        id="allHabitsProgressChart"
        class="w-100"
        style="height: 280px"
      ></canvas>
    </div>
  </div>
</div>

    </div>

  </div>

<!-- Librería de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

  // Datos dinámicos para las categorías
  const categories = {{ byCategory | safe }};
  const categoriesName = Object.keys(categories);
  const categoriesValue = Object.values(categories);

  

  // Datos dinámicos para las frecuencias
  const frequencies = {{ byFrequency | safe }};
  const frequenciesName = Object.keys(frequencies);
  const frequenciesValue = Object.values(frequencies);

  const totalSum = categoriesValue.reduce((a, b) => a + b);

  // Definir los colores según las categorías
  const bgcolors = categoriesName.map(category => {
    switch(category) {
        case 'Escuela':
            return 'blue';
        case 'Trabajo':
            return 'deeppink';
        case 'Hogar':
            return 'darkorange';
        case 'Salud':
            return 'rgb(9, 192, 122)';
        case 'Hobby':
            return '#8500CF';
        case 'Otros':
            return 'olive';
        default:
            return '#CCCCCC';
    }
});

// Gráfico de categorías
var ctx = document.getElementById('habitRadarChart').getContext('2d');
    var habitRadarChart = new Chart(ctx, {
        type: 'radar',  // Tipo de gráfico: 'radar'
        data: {
            labels: {{ habit_names|safe }},  // Los nombres de los hábitos
            datasets: [{
                label: 'Repeticiones de hábitos',
                data: {{ habit_repetitions|safe }},  // Las repeticiones de cada hábito
                backgroundColor: 'rgba(54, 162, 235, 0.2)',  // Color de fondo semitransparente
                borderColor: 'rgba(54, 162, 235, 1)',  // Color de la línea
                borderWidth: 2,  // Grosor de la línea
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',  // Color de los puntos
                pointBorderColor: '#fff',  // Borde de los puntos
                pointHoverBackgroundColor: '#fff',  // Color de los puntos al hacer hover
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)',  // Borde de los puntos al hacer hover
            }]
        },
        options: {
            responsive: true,
            elements: {
                line: {
                    tension: 0.3  // Curvatura de las líneas (valor entre 0 y 1, 0 es recto)
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',  // Posición de la leyenda
                },
            },
            scales: {
                r: {
                    angleLines: {
                        display: true  // Mostrar las líneas de los ángulos
                    },
                    suggestedMin: 0,  // El mínimo sugerido para el valor en el gráfico
                    suggestedMax: Math.max(...{{ habit_repetitions|safe }}) + 2  // Ajustar el máximo según las repeticiones
                }
            }
        }
    });


  // Gráfico de frecuencias
  const ctxByFrequency = document.getElementById('byFrequency').getContext('2d');
  new Chart(ctxByFrequency, {
      type: 'bar',
      data: {
          labels: frequenciesName,
          datasets: [{
              label: "Frecuencias",
              data: frequenciesValue,
              backgroundColor: bgcolors,
              borderColor: '#DAF7A6',
              borderWidth: 1
          }]
      },
      options: {
          scales: {
              y: {
                  beginAtZero: true
              }
          },
          plugins: {
              tooltip: {
                  callbacks: {
                      label: function (args) {
                          return `${(args.raw / totalSum * 100).toFixed(2)}% del total`;
                      }
                  }
              }
          }
      }
  });

  var ctx = document.getElementById('completionChart').getContext('2d');
    var completionChart = new Chart(ctx, {
      type: 'polarArea',  // Tipo de gráfico: 'polarArea'
        data: {
            labels: {{ frequency_labels|safe }},  // Las etiquetas de las frecuencias
            datasets: [{
                label: 'Frecuencia de hábitos',
                data: {{ frequency_data|safe }},  // La cantidad de hábitos para cada frecuencia
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'right',  // Leyenda posicionada a la derecha
                },
            },
            scale: {
                ticks: {
                    beginAtZero: true
                }
            }
        }
    });



  // Nuevas Gráficas
  document.addEventListener('DOMContentLoaded', function () {

      // Gráfico de hábitos creados
  var ctxSteps = document.getElementById('stepsChart').getContext('2d');

var gradientSteps = ctxSteps.createLinearGradient(0, 0, 0, 400);
gradientSteps.addColorStop(0, 'rgba(255, 99, 132, 1)');
gradientSteps.addColorStop(0.1, 'rgba(255, 99, 132, 0.9)');
gradientSteps.addColorStop(0.2, 'rgba(255, 99, 132, 0.7)');
gradientSteps.addColorStop(0.3, 'rgba(255, 99, 132, 0.5)');
gradientSteps.addColorStop(0.5, 'rgba(255, 99, 132, 0.3)');
gradientSteps.addColorStop(0.7, 'rgba(255, 99, 132, 0.2)');
gradientSteps.addColorStop(0.9, 'rgba(255, 99, 132, 0.1)');
gradientSteps.addColorStop(1, 'rgba(255, 99, 132, 0)');

const labels_stepsChart = {{labels|safe}};
const data_stepsChart = {{data|safe}};

var stepsChart = new Chart(ctxSteps, {
    type: 'line',
    data: {
        labels: labels_stepsChart,  // Las etiquetas del eje X
        datasets: [{
            label: 'Hábitos creados',
            data: data_stepsChart,
            borderColor: '#FF464F',
            borderWidth: 2,
            fill: true,
            backgroundColor: gradientSteps,
            pointRadius: 0,
            pointHoverRadius: 8,
            pointHoverBorderColor: '#FF464F',
            pointHoverBackgroundColor: 'white'
        }]
    },
    options: {
        elements: {
            point: {
                radius: function (context) {
                    return context.dataIndex === 2 ? 10 : 0;
                },
                backgroundColor: function (context) {
                    return context.dataIndex === 2 ? '#FF464F' : 'rgba(255, 99, 132, 0)';
                },
                borderColor: function (context) {
                    return context.dataIndex === 2 ? '#FFFFFF' : '#FF464F';
                },
                borderWidth: 5,
            },
            line: {
                tension: 0.4
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function (tooltipItem) {
                        return 'Hábitos: ' + tooltipItem.raw;
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    borderDash: [5, 5],
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                    color: 'white',  // Cambiar el color de los labels del eje X a blanco
                    font: {
                        family: 'Anta',
                        size: 12
                    },
                    maxRotation: 75, // Rotar las etiquetas
                    minRotation: 75
                }
            },
            y: {
                display: false
            }
        },
        layout: {
            padding: {
                left: 10,
                right: 10,
                top: 10,
                bottom: 10
            }
        },
        hover: {
            mode: 'nearest',
            intersect: true
        },
        interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
        }
    }
});


  // <!-- Gráfico del Hábito Específico -->
var ctxWater = document.getElementById('waterChart').getContext('2d');
var waterChart = new Chart(ctxWater, {
    type: 'bar',
    data: {
        labels: {{ habit_labels|safe }},
        datasets: [
            {
                label: 'Progreso Total',
                data: Array({{ habit_labels|length }}).fill({{ total_repetitions }}), // Array con el objetivo total
                backgroundColor: '#FF464F' + '80', // Tono más claro para el progreso total
                borderWidth: 1,
                borderRadius: 10,
                borderSkipped: false,
                barThickness: 15
            },
            {
                label: 'Progreso Actual',
                data: {{ habit_data|safe }},
                backgroundColor: '#FF464F', // Tono más oscuro para el progreso actual
                borderWidth: 1,
                borderRadius: 10,
                borderSkipped: false,
                barThickness: 15 // Un poco más delgado para que se note el progreso total de fondo
            }
        ]
    },
    options: {
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#A9A9A9',
                    font: {
                        size: 14,
                        family: 'Anta'
                    }
                }
            },
            y: {
                beginAtZero: true,
                max: {{ total_repetitions }},
                ticks: {
                    display: false
                },
                grid: {
                    color: '#E0E0E0',
                    borderDash: [5, 5],
                    drawBorder: false
                }
            }
        }
    }
});


    // Define los colores para cada día de la semana
var dayColors = {
    0: '#FF464F',  // Domingo
    1: '#36A2EB',  // Lunes
    2: '#FFCE56',  // Martes
    3: '#4BC0C0',  // Miércoles
    4: '#9966FF',  // Jueves
    5: '#FF9F40',  // Viernes
    6: '#FF6384'   // Sábado
};

// Generar un array de colores basados en el día de la semana para el progreso actual
var barColorsCurrent = {{ all_habits_labels|safe }}.map(function(label) {
    var date = new Date(label);
    return dayColors[date.getDay()];  // Obtener el color basado en el día de la semana
});

// Generar un array de colores en un tono más claro para el progreso total
var barColorsTotal = barColorsCurrent.map(function(color) {
    // Crear un color más claro utilizando una transparencia
    return color + '80';  // Agrega '80' al final del color para un 50% de transparencia
});

var ctxAllHabits = document.getElementById('allHabitsProgressChart').getContext('2d');
var allHabitsProgressChart = new Chart(ctxAllHabits, {
    type: 'bar',
    data: {
        labels: {{ all_habits_labels|safe }},  // Fechas de actualización
        datasets: [
            {
                label: 'Progreso Total',
                data: {{ all_habits_total_data|safe }},  // Progreso total
                backgroundColor: barColorsTotal,  // Colores claros para el progreso total
                borderWidth: 1,
                borderRadius: 10,
                borderSkipped: false,
                barThickness: 15
            },
            {
                label: 'Progreso Actual',
                data: {{ all_habits_current_data|safe }},  // Progreso actual
                backgroundColor: barColorsCurrent,  // Colores dinámicos basados en el día de la semana
                borderWidth: 1,
                borderRadius: 10,
                borderSkipped: false,
                barThickness: 15  // Un grosor ligeramente menor para superponerlo
            }
        ]
    },
    options: {
        plugins: {
            legend: {
                display: false  // Cambia a 'true' si quieres mostrar la leyenda
            }
        },
        scales: {
            x: {
                grid: {
                    display: false  // Ocultar la rejilla en el eje X
                },
                ticks: {
                    color: '#A9A9A9',  // Color de los labels (fechas)
                    font: {
                        size: 14,
                        family: 'Anta'  // Mantener la misma fuente
                    }
                }
            },
            y: {
                beginAtZero: true,  // Comenzar el eje Y desde cero
                ticks: {
                    display: false  // Ocultar los números en el eje Y
                },
                grid: {
                    color: '#E0E0E0',  // Color de la rejilla en el eje Y
                    borderDash: [5, 5],  // Línea discontinua para la rejilla
                    drawBorder: false  // No mostrar el borde del eje
                }
            }
        }
    }
});


  });
</script>

{% endblock %}
